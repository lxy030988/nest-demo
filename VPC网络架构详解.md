# VPC ç½‘ç»œæ¶æ„è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Šäº† AWS VPCã€å­ç½‘ã€è·¯ç”±è¡¨ã€NAT Gateway çš„å·¥ä½œåŸç†ï¼Œä»¥åŠ Lambda å¦‚ä½•é€šè¿‡ç§æœ‰å­ç½‘è®¿é—®äº’è”ç½‘ã€‚

---

## ğŸ“– ç›®å½•

- [åŸºæœ¬æ¦‚å¿µ](#åŸºæœ¬æ¦‚å¿µ)
- [ç½‘ç»œæ‹“æ‰‘](#ç½‘ç»œæ‹“æ‰‘)
- [å­ç½‘ç±»å‹](#å­ç½‘ç±»å‹)
- [ç½‘å…³è¯¦è§£](#ç½‘å…³è¯¦è§£)
- [è·¯ç”±è¡¨å·¥ä½œåŸç†](#è·¯ç”±è¡¨å·¥ä½œåŸç†)
- [Lambdaè®¿é—®äº’è”ç½‘æµç¨‹](#lambdaè®¿é—®äº’è”ç½‘æµç¨‹)
- [å®é™…é…ç½®éªŒè¯](#å®é™…é…ç½®éªŒè¯)

---

## åŸºæœ¬æ¦‚å¿µ

### VPC (Virtual Private Cloud)

**è™šæ‹Ÿç§æœ‰äº‘** - åœ¨ AWS äº‘ä¸­çš„ä¸€ä¸ªéš”ç¦»çš„è™šæ‹Ÿç½‘ç»œã€‚

```
VPC = ä½ çš„ç§äººç½‘ç»œç©ºé—´
- IP åœ°å€èŒƒå›´: 10.0.0.0/16 (65,536 ä¸ª IP åœ°å€)
- å®Œå…¨éš”ç¦»ï¼Œä¸å…¶ä»– AWS è´¦æˆ·çš„ VPC åˆ†å¼€
- å¯ä»¥è‡ªå®šä¹‰å­ç½‘ã€è·¯ç”±è¡¨ã€ç½‘å…³
```

### å­ç½‘ (Subnet)

**å­ç½‘** - VPC å†…çš„ IP åœ°å€èŒƒå›´åˆ†æ®µã€‚

```
VPC: 10.0.0.0/16
â”œâ”€â”€ å…¬ç½‘å­ç½‘: 10.0.1.0/24   (256ä¸ªIP)
â”œâ”€â”€ ç§ç½‘å­ç½‘1: 10.0.11.0/24 (256ä¸ªIP)
â”œâ”€â”€ ç§ç½‘å­ç½‘2: 10.0.12.0/24 (256ä¸ªIP)
â””â”€â”€ ç§ç½‘å­ç½‘3: 10.0.13.0/24 (256ä¸ªIP)
```

### CIDR è¡¨ç¤ºæ³•

| CIDR | IP æ•°é‡ | ç¤ºä¾‹                 |
| ---- | ------- | -------------------- |
| /16  | 65,536  | 10.0.0.0/16          |
| /24  | 256     | 10.0.1.0/24          |
| /32  | 1       | 10.0.1.5/32 (å•ä¸ªIP) |

---

## ç½‘ç»œæ‹“æ‰‘

### å®Œæ•´æ¶æ„å›¾

```
                        äº’è”ç½‘
                          â†‘
                          |
                 Internet Gateway
                          â†‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPC: vpc-018e25430281bdb1b (10.0.0.0/16)             â”‚
â”‚                         â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å…¬ç½‘å­ç½‘ (10.0.1.0/24) - us-east-1a              â”‚ â”‚
â”‚  â”‚                      â”‚                            â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚   â”‚ NAT Gateway                       â”‚          â”‚ â”‚
â”‚  â”‚   â”‚ - Elastic IP: 54.144.171.51      â”‚          â”‚ â”‚
â”‚  â”‚   â”‚ - åœ°å€è½¬æ¢æœåŠ¡                    â”‚          â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â†‘                              â”‚
â”‚                         â”‚ (ç§ç½‘æµé‡ç»è¿‡è¿™é‡Œ)           â”‚
â”‚                         â”‚                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ç§ç½‘å­ç½‘ 1 (10.0.11.0/24) - us-east-1a          â”‚ â”‚
â”‚  â”‚                      â”‚                            â”‚ â”‚
â”‚  â”‚   Lambda å®ä¾‹ â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚ â”‚
â”‚  â”‚   RDS æ•°æ®åº“                                      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç§ç½‘å­ç½‘ 2 (10.0.12.0/24) - us-east-1b         â”‚  â”‚
â”‚  â”‚   Lambda å®ä¾‹                                    â”‚  â”‚
â”‚  â”‚   RDS æ•°æ®åº“                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ç§ç½‘å­ç½‘ 3 (10.0.13.0/24) - us-east-1c         â”‚  â”‚
â”‚  â”‚   Lambda å®ä¾‹                                    â”‚  â”‚
â”‚  â”‚   RDS æ•°æ®åº“                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### èµ„æºåˆ†å¸ƒ

| èµ„æº             | éƒ¨ç½²ä½ç½®    | æ•°é‡ | ä½œç”¨         |
| ---------------- | ----------- | ---- | ------------ |
| Lambda           | 3ä¸ªç§ç½‘å­ç½‘ | åŠ¨æ€ | è¿è¡Œåº”ç”¨ä»£ç  |
| RDS              | 3ä¸ªç§ç½‘å­ç½‘ | 1ä¸ª  | æ•°æ®åº“       |
| NAT Gateway      | 1ä¸ªå…¬ç½‘å­ç½‘ | 1ä¸ª  | åœ°å€è½¬æ¢     |
| Internet Gateway | VPCè¾¹ç•Œ     | 1ä¸ª  | äº’è”ç½‘å‡ºå£   |

---

## å­ç½‘ç±»å‹

### å…¬ç½‘å­ç½‘ (Public Subnet)

**ç‰¹ç‚¹**ï¼š

- âœ… æœ‰è·¯ç”±åˆ° Internet Gateway
- âœ… èµ„æºå¯è·å¾—å…¬ç½‘ IP
- âœ… å¯ä»¥è¢«äº’è”ç½‘ç›´æ¥è®¿é—®ï¼ˆå¦‚æœé…ç½®å…è®¸ï¼‰

**è·¯ç”±è¡¨**ï¼š

```
ç›®æ ‡åœ°å€          | ä¸‹ä¸€è·³
-----------------|------------------
10.0.0.0/16      | local (VPCå†…)
0.0.0.0/0        | Internet Gateway
```

**å½“å‰ç”¨é€”**ï¼š

- éƒ¨ç½² NAT Gateway
- ä½œä¸ºç§ç½‘çš„å‡ºå£ä¸­è½¬ç«™

### ç§ç½‘å­ç½‘ (Private Subnet)

**ç‰¹ç‚¹**ï¼š

- âŒ æ²¡æœ‰è·¯ç”±åˆ° Internet Gateway
- âŒ èµ„æºä¸èƒ½è·å¾—å…¬ç½‘ IP
- âŒ ä¸èƒ½è¢«äº’è”ç½‘ç›´æ¥è®¿é—®
- âœ… é€šè¿‡ NAT Gateway è®¿é—®äº’è”ç½‘ï¼ˆå•å‘å‡ºç«™ï¼‰

**è·¯ç”±è¡¨**ï¼š

```
ç›®æ ‡åœ°å€          | ä¸‹ä¸€è·³
-----------------|------------------
10.0.0.0/16      | local (VPCå†…)
0.0.0.0/0        | NAT Gateway
```

**å½“å‰ç”¨é€”**ï¼š

- éƒ¨ç½² Lambda å‡½æ•°
- éƒ¨ç½² RDS æ•°æ®åº“
- å†…éƒ¨æœåŠ¡é€šä¿¡

---

## ç½‘å…³è¯¦è§£

### NAT Gateway (ç½‘ç»œåœ°å€è½¬æ¢ç½‘å…³)

**ä½œç”¨**ï¼šè®©ç§æœ‰å­ç½‘çš„èµ„æºè®¿é—®äº’è”ç½‘

**å·¥ä½œåŸç†**ï¼š

```
1. æ¥æ”¶ç§ç½‘IPçš„å‡ºç«™è¯·æ±‚
   æº: 10.0.11.5:12345

2. æ›¿æ¢ä¸ºè‡ªå·±çš„å…¬ç½‘IP
   æº: 54.144.171.51:12345

3. å‘é€åˆ°äº’è”ç½‘

4. æ¥æ”¶å“åº”

5. è½¬æ¢å›ç§ç½‘IP
   ç›®æ ‡: 10.0.11.5:12345

6. è¿”å›ç»™åŸå§‹è¯·æ±‚è€…
```

**ç‰¹æ€§**ï¼š

- âœ… å•å‘é€šä¿¡ï¼šç§ç½‘ â†’ å…¬ç½‘
- âŒ å…¬ç½‘ä¸èƒ½ä¸»åŠ¨è¿æ¥ç§ç½‘
- ğŸ’° æ”¶è´¹ï¼š$0.045/å°æ—¶ + $0.045/GB

**ç±»æ¯”**ï¼š

> NAT Gateway å°±åƒå°åŒºé—¨å£çš„ä»£æ”¶å¿«é€’ç‚¹ï¼Œä½ ç”¨å®ƒçš„åœ°å€æ”¶å‘å¿«é€’ï¼Œå¤–é¢çš„äººä¸çŸ¥é“ä½ å®¶å…·ä½“åœ°å€ã€‚

### Internet Gateway (äº’è”ç½‘ç½‘å…³)

**ä½œç”¨**ï¼šVPC ä¸äº’è”ç½‘ä¹‹é—´çš„æ¡¥æ¢

**å·¥ä½œåŸç†**ï¼š

```
VPC â†â†’ Internet Gateway â†â†’ äº’è”ç½‘
```

**ç‰¹æ€§**ï¼š

- âœ… åŒå‘é€šä¿¡ï¼ˆå¦‚æœé…ç½®å…è®¸ï¼‰
- âœ… é«˜å¯ç”¨ã€è‡ªåŠ¨æ‰©å±•
- ğŸ’° å…è´¹

**å…³ç³»**ï¼š

- NAT Gateway â†’ Internet Gateway â†’ äº’è”ç½‘
- å…¬ç½‘å­ç½‘ â†’ Internet Gateway â†’ äº’è”ç½‘

---

## è·¯ç”±è¡¨å·¥ä½œåŸç†

### ä»€ä¹ˆæ˜¯è·¯ç”±è¡¨

**è·¯ç”±è¡¨** = ç½‘ç»œçš„"åœ°å›¾"ï¼Œå‘Šè¯‰æ•°æ®åŒ…è¯¥å¾€å“ªé‡Œèµ°ã€‚

### è·¯ç”±è§„åˆ™

æ¯æ¡è·¯ç”±è§„åˆ™åŒ…å«ï¼š

1. **ç›®æ ‡åœ°å€** (Destination)
2. **ä¸‹ä¸€è·³** (Target)

### ç§ç½‘å­ç½‘è·¯ç”±è¡¨

```yaml
è·¯ç”±è¡¨: PrivateRouteTable
è§„åˆ™:
  - ç›®æ ‡: 10.0.0.0/16
    ä¸‹ä¸€è·³: local
    è¯´æ˜: VPCå†…éƒ¨é€šä¿¡ï¼Œç›´æ¥è·¯ç”±

  - ç›®æ ‡: 0.0.0.0/0
    ä¸‹ä¸€è·³: nat-00914e04da24839a1
    è¯´æ˜: æ‰€æœ‰å¤–ç½‘æµé‡ï¼Œå‘å¾€NAT Gateway
```

**åŒ¹é…é€»è¾‘**ï¼š

```
Lambdaè¦è®¿é—®: api.github.com (IP: 140.82.112.6)

1. æ£€æŸ¥ç¬¬ä¸€æ¡è§„åˆ™:
   140.82.112.6 åŒ¹é… 10.0.0.0/16ï¼Ÿ
   â†’ âŒ ä¸åŒ¹é…

2. æ£€æŸ¥ç¬¬äºŒæ¡è§„åˆ™:
   140.82.112.6 åŒ¹é… 0.0.0.0/0ï¼Ÿ
   â†’ âœ… åŒ¹é…ï¼ˆ0.0.0.0/0åŒ¹é…æ‰€æœ‰IPï¼‰
   â†’ ä¸‹ä¸€è·³: NAT Gateway
```

### å…¬ç½‘å­ç½‘è·¯ç”±è¡¨

```yaml
è·¯ç”±è¡¨: PublicRouteTable
è§„åˆ™:
  - ç›®æ ‡: 10.0.0.0/16
    ä¸‹ä¸€è·³: local
    è¯´æ˜: VPCå†…éƒ¨é€šä¿¡

  - ç›®æ ‡: 0.0.0.0/0
    ä¸‹ä¸€è·³: igw-xxx
    è¯´æ˜: å¤–ç½‘æµé‡ï¼Œç›´æ¥å‘å¾€Internet Gateway
```

### è·¯ç”±è¡¨å…³è”

```
PrivateSubnet1 â”€â”€â”
PrivateSubnet2 â”€â”€â”¼â”€â”€â†’ PrivateRouteTable
PrivateSubnet3 â”€â”€â”˜

PublicSubnet â”€â”€â†’ PublicRouteTable
```

**ä¸€ä¸ªå­ç½‘åªèƒ½å…³è”ä¸€ä¸ªè·¯ç”±è¡¨ï¼Œä½†ä¸€ä¸ªè·¯ç”±è¡¨å¯ä»¥è¢«å¤šä¸ªå­ç½‘ä½¿ç”¨ã€‚**

---

## Lambdaè®¿é—®äº’è”ç½‘æµç¨‹

### å®Œæ•´æµç¨‹å›¾

```
æ­¥éª¤1: Lambdaå‘èµ·è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lambda (10.0.11.5)              â”‚
â”‚ "GET https://api.github.com"    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“

æ­¥éª¤2: æŸ¥è¯¢è·¯ç”±è¡¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPCè·¯ç”±å™¨                       â”‚
â”‚ æŸ¥è¯¢: PrivateRouteTable         â”‚
â”‚ åŒ¹é…è§„åˆ™: 0.0.0.0/0 â†’ NAT      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“

æ­¥éª¤3: è½¬å‘åˆ°NAT Gateway
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NAT Gateway (å…¬ç½‘å­ç½‘)          â”‚
â”‚ åœ°å€è½¬æ¢:                       â”‚
â”‚   æº: 10.0.11.5 â†’ 54.144.171.51â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“

æ­¥éª¤4: é€šè¿‡Internet Gateway
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Internet Gateway                â”‚
â”‚ å‘é€åˆ°äº’è”ç½‘                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“

æ­¥éª¤5: åˆ°è¾¾ç›®æ ‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ api.github.com                  â”‚
â”‚ çœ‹åˆ°çš„æºIP: 54.144.171.51      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â†“

æ­¥éª¤6-9: åŸè·¯è¿”å›
GitHub â†’ Internet Gateway â†’ NAT â†’ Lambda
```

### è¯¦ç»†æ­¥éª¤è¯´æ˜

#### æ­¥éª¤ 1: Lambda å‘èµ·è¯·æ±‚

```javascript
// Lambda ä»£ç 
axios.get('https://api.github.com/users/torvalds')

// ç½‘ç»œå±‚
æºIP: 10.0.11.5
æºç«¯å£: 45678
ç›®æ ‡IP: 140.82.112.6 (GitHub)
ç›®æ ‡ç«¯å£: 443
```

#### æ­¥éª¤ 2: VPC è·¯ç”±å™¨æŸ¥è¯¢è·¯ç”±è¡¨

```
VPCè·¯ç”±å™¨: "140.82.112.6 å»å“ªé‡Œï¼Ÿ"
æŸ¥è¯¢è·¯ç”±è¡¨: PrivateRouteTable
åŒ¹é…ç»“æœ: 0.0.0.0/0 â†’ NAT Gateway (nat-00914...)
å†³å®š: å‘é€åˆ° NAT Gateway
```

#### æ­¥éª¤ 3: NAT Gateway åœ°å€è½¬æ¢

```
æ¥æ”¶:
  æº: 10.0.11.5:45678
  ç›®æ ‡: 140.82.112.6:443

è½¬æ¢å:
  æº: 54.144.171.51:45678 (æ›¿æ¢ä¸ºNATçš„å…¬ç½‘IP)
  ç›®æ ‡: 140.82.112.6:443

è®°å½•è½¬æ¢è¡¨:
  10.0.11.5:45678 â†â†’ 54.144.171.51:45678
```

#### æ­¥éª¤ 4: Internet Gateway å‘é€

```
ä»NAT Gatewayæ¥æ”¶æ•°æ®åŒ…
å‘é€åˆ°äº’è”ç½‘
ç›®æ ‡: 140.82.112.6:443
```

#### æ­¥éª¤ 5: GitHub æ¥æ”¶è¯·æ±‚

```
GitHubçœ‹åˆ°çš„:
  æºIP: 54.144.171.51 (NATçš„å…¬ç½‘IP)
  ä¸çŸ¥é“çœŸå®çš„Lambda IP (10.0.11.5)
```

#### æ­¥éª¤ 6-9: å“åº”è¿”å›

```
GitHub â†’ Internet Gateway
    â†“
Internet Gateway â†’ NAT Gateway
    â†“
NATæŸ¥æ‰¾è½¬æ¢è¡¨: 54.144.171.51:45678 â†’ 10.0.11.5:45678
    â†“
NAT â†’ Lambda (10.0.11.5)
```

### å…³é”®ç‚¹

1. **Lambda æ— å…¬ç½‘ IP**
   - Lambda åªæœ‰ç§æœ‰ IP (10.0.11.x)
   - ä¸èƒ½è¢«äº’è”ç½‘ç›´æ¥è®¿é—®

2. **NAT æä¾›å…¬ç½‘ IP**
   - NAT Gateway æœ‰å…¬ç½‘ IP (54.144.171.51)
   - ä»£æ›¿ Lambda ä¸äº’è”ç½‘é€šä¿¡

3. **å•å‘é€šä¿¡**
   - Lambda å¯ä»¥ä¸»åŠ¨è®¿é—®äº’è”ç½‘ âœ…
   - äº’è”ç½‘ä¸èƒ½ä¸»åŠ¨è®¿é—® Lambda âŒ

4. **çŠ¶æ€ä¼šè¯**
   - NAT è®°ä½äº†å“ªä¸ªç§æœ‰ IP å‘èµ·çš„è¯·æ±‚
   - å“åº”å¯ä»¥æ­£ç¡®è¿”å›

---

## å®é™…é…ç½®éªŒè¯

### æŸ¥çœ‹ Lambda VPC é…ç½®

```bash
aws lambda get-function-configuration \
  --function-name nest-demo-stack-nestjs-api \
  --query 'VpcConfig'
```

**è¾“å‡º**ï¼š

```json
{
  "SubnetIds": [
    "subnet-0bf0b91dc38d3361c", // ç§ç½‘å­ç½‘1
    "subnet-00b27915613684c03", // ç§ç½‘å­ç½‘2
    "subnet-0c12cbecf0c33565a" // ç§ç½‘å­ç½‘3
  ],
  "SecurityGroupIds": ["sg-06f50247d4bf43ccb"],
  "VpcId": "vpc-018e25430281bdb1b"
}
```

### æŸ¥çœ‹å­ç½‘è¯¦æƒ…

```bash
aws ec2 describe-subnets \
  --subnet-ids subnet-0bf0b91dc38d3361c \
               subnet-00b27915613684c03 \
               subnet-0c12cbecf0c33565a
```

**ç»“æœ**ï¼š
| å¯ç”¨åŒº | CIDR | å­ç½‘ID | ç±»å‹ |
|--------|------|--------|------|
| us-east-1a | 10.0.11.0/24 | subnet-0bf0... | ç§ç½‘ |
| us-east-1b | 10.0.12.0/24 | subnet-00b2... | ç§ç½‘ |
| us-east-1c | 10.0.13.0/24 | subnet-0c12... | ç§ç½‘ |

### æŸ¥çœ‹ NAT Gateway

```bash
aws ec2 describe-nat-gateways \
  --filter "Name=vpc-id,Values=vpc-018e25430281bdb1b"
```

**ç»“æœ**ï¼š

```json
{
  "SubnetId": "subnet-064b23c3e8428f257", // å…¬ç½‘å­ç½‘
  "State": "available",
  "PublicIp": "54.144.171.51"
}
```

### æŸ¥çœ‹è·¯ç”±è¡¨

```bash
aws ec2 describe-route-tables \
  --filters "Name=tag:Name,Values=nest-demo-stack-private-rt"
```

**ç»“æœ**ï¼š

```
ç›®æ ‡åœ°å€          | ä¸‹ä¸€è·³                | çŠ¶æ€
-----------------|----------------------|--------
10.0.0.0/16      | local                | active
0.0.0.0/0        | nat-00914e04da2483... | active
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦å…¬ç½‘å­ç½‘ï¼Ÿ

**A**: è™½ç„¶ Lambda éƒ¨ç½²åœ¨ç§ç½‘å­ç½‘ï¼Œä½† NAT Gateway å¿…é¡»éƒ¨ç½²åœ¨å…¬ç½‘å­ç½‘ã€‚å…¬ç½‘å­ç½‘çš„ä½œç”¨å°±æ˜¯æ‰˜ç®¡ NAT Gatewayã€‚

### Q2: 3 ä¸ªç§ç½‘å­ç½‘éƒ½èƒ½è®¿é—®äº’è”ç½‘å—ï¼Ÿ

**A**: æ˜¯çš„ï¼3 ä¸ªç§ç½‘å­ç½‘éƒ½å…³è”åˆ°åŒä¸€ä¸ªè·¯ç”±è¡¨ï¼Œéƒ½é…ç½®äº† `0.0.0.0/0 â†’ NAT Gateway`ï¼Œæ‰€ä»¥éƒ½èƒ½è®¿é—®äº’è”ç½‘ã€‚

### Q3: NAT Gateway è´µå—ï¼Ÿ

**A**:

- æŒ‰å°æ—¶: $0.045/å°æ—¶ â‰ˆ $32.4/æœˆ
- æŒ‰æµé‡: $0.045/GB
- æ€»è®¡: ~$35-40/æœˆï¼ˆä½æµé‡æƒ…å†µï¼‰

### Q4: å¯ä»¥ä¸ç”¨ NAT Gateway å—ï¼Ÿ

**A**:

- å¦‚æœ Lambda ä¸éœ€è¦è®¿é—®äº’è”ç½‘ â†’ å¯ä»¥åˆ é™¤
- å¦‚æœåªéœ€è¦è®¿é—® AWS æœåŠ¡ â†’ å¯ä»¥ç”¨ VPC Endpoint æ›¿ä»£
- å¦‚æœéœ€è¦è®¿é—®ç¬¬ä¸‰æ–¹ API â†’ å¿…é¡»ä¿ç•™

### Q5: ä¸ºä»€ä¹ˆ Lambda éƒ¨ç½²åœ¨ 3 ä¸ªå­ç½‘ï¼Ÿ

**A**:

- é«˜å¯ç”¨æ€§ï¼šåˆ†å¸ƒåœ¨ 3 ä¸ªå¯ç”¨åŒº
- å®¹é”™èƒ½åŠ›ï¼šä¸€ä¸ªå¯ç”¨åŒºæ•…éšœä¸å½±å“æœåŠ¡
- è´Ÿè½½å‡è¡¡ï¼šAWS è‡ªåŠ¨åˆ†é…å®ä¾‹

---

## æˆæœ¬ä¼˜åŒ–å»ºè®®

### å¦‚æœä¸éœ€è¦è®¿é—®å…¬ç½‘

```yaml
# åˆ é™¤ NAT Gateway å’Œå…¬ç½‘å­ç½‘
# Lambda åªèƒ½è®¿é—®:
- VPC å†…éƒ¨èµ„æº (RDS)
- AWS æœåŠ¡ (é€šè¿‡ VPC Endpoint)

# èŠ‚çœ:
- NAT Gateway: ~$32.4/æœˆ
- æ•°æ®ä¼ è¾“è´¹ç”¨
```

### ä½¿ç”¨ VPC Endpoint

```yaml
# å¦‚æœåªéœ€è¦è®¿é—® S3ã€DynamoDB ç­‰ AWS æœåŠ¡
S3VPCEndpoint:
  Type: AWS::EC2::VPCEndpoint
  Properties:
    VpcId: !Ref VPC
    ServiceName: !Sub com.amazonaws.${AWS::Region}.s3
    RouteTableIds:
      - !Ref PrivateRouteTable

# å¥½å¤„:
- ä¸éœ€è¦ NAT Gateway
- æµé‡ä¸ç»è¿‡å…¬ç½‘
- å…è´¹
```

---

## template.yaml é…ç½®å‚è€ƒ

### VPC å’Œå­ç½‘

```yaml
VPC:
  Type: AWS::EC2::VPC
  Properties:
    CidrBlock: 10.0.0.0/16

PublicSubnet:
  Type: AWS::EC2::Subnet
  Properties:
    VpcId: !Ref VPC
    CidrBlock: 10.0.1.0/24
    MapPublicIpOnLaunch: true

PrivateSubnet1:
  Type: AWS::EC2::Subnet
  Properties:
    VpcId: !Ref VPC
    CidrBlock: 10.0.11.0/24
    AvailabilityZone: !Select [0, !GetAZs '']
```

### NAT Gateway

```yaml
NATGatewayEIP:
  Type: AWS::EC2::EIP
  Properties:
    Domain: vpc

NATGateway:
  Type: AWS::EC2::NatGateway
  Properties:
    AllocationId: !GetAtt NATGatewayEIP.AllocationId
    SubnetId: !Ref PublicSubnet # å¿…é¡»åœ¨å…¬ç½‘å­ç½‘
```

### è·¯ç”±è¡¨

```yaml
PrivateRouteTable:
  Type: AWS::EC2::RouteTable
  Properties:
    VpcId: !Ref VPC

PrivateRoute:
  Type: AWS::EC2::Route
  Properties:
    RouteTableId: !Ref PrivateRouteTable
    DestinationCidrBlock: 0.0.0.0/0 # æ‰€æœ‰å¤–ç½‘æµé‡
    NatGatewayId: !Ref NATGateway # å‘å¾€ NAT

PrivateSubnet1RouteTableAssociation:
  Type: AWS::EC2::SubnetRouteTableAssociation
  Properties:
    SubnetId: !Ref PrivateSubnet1
    RouteTableId: !Ref PrivateRouteTable
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **VPC = ä½ çš„ç§äººç½‘ç»œ**
   - å®Œå…¨éš”ç¦»çš„è™šæ‹Ÿç½‘ç»œç©ºé—´
   - IP èŒƒå›´: 10.0.0.0/16

2. **å­ç½‘ = ç½‘ç»œåˆ†æ®µ**
   - å…¬ç½‘å­ç½‘ï¼šéƒ¨ç½² NAT Gateway
   - ç§ç½‘å­ç½‘ï¼šéƒ¨ç½² Lambda å’Œ RDS

3. **è·¯ç”±è¡¨ = ç½‘ç»œåœ°å›¾**
   - å‘Šè¯‰æ•°æ®åŒ…è¯¥å¾€å“ªé‡Œèµ°
   - `0.0.0.0/0 â†’ NAT Gateway`

4. **NAT Gateway = åœ°å€è½¬æ¢å™¨**
   - è®©ç§ç½‘èµ„æºè®¿é—®äº’è”ç½‘
   - ç§æœ‰ IP â†â†’ å…¬ç½‘ IP

5. **æµé‡è·¯å¾„**
   ```
   Lambda (ç§ç½‘) â†’ NAT (å…¬ç½‘å­ç½‘) â†’ Internet Gateway â†’ äº’è”ç½‘
   ```

### è®°ä½è¿™ä¸ªæ¯”å–»

```
VPC = å°åŒº
â”œâ”€â”€ å…¬ç½‘å­ç½‘ = å°åŒºé—¨å£
â”‚   â””â”€â”€ NAT Gateway = å¿«é€’ä»£æ”¶ç‚¹
â”œâ”€â”€ ç§ç½‘å­ç½‘ = å°åŒºå†…éƒ¨
â”‚   â”œâ”€â”€ Lambda = ä½ å®¶
â”‚   â””â”€â”€ RDS = é‚»å±…å®¶
â””â”€â”€ Internet Gateway = å°åŒºå¤§é—¨
```

**è®¿é—®äº’è”ç½‘**ï¼š
ä½ å®¶ï¼ˆLambdaï¼‰â†’ å¿«é€’ä»£æ”¶ç‚¹ï¼ˆNATï¼‰â†’ å°åŒºå¤§é—¨ï¼ˆIGWï¼‰â†’ å¤–é¢ä¸–ç•Œï¼ˆäº’è”ç½‘ï¼‰
