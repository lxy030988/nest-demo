# NestJS Lambda éƒ¨ç½²å®Œæ•´æŒ‡å—

æœ¬æŒ‡å—åŒ…å« NestJS åº”ç”¨éƒ¨ç½²åˆ° AWS Lambda çš„æ‰€æœ‰ä¿¡æ¯ï¼Œä»å¿«é€Ÿå¼€å§‹åˆ°è¯¦ç»†æ¶æ„è¯´æ˜ã€‚

## ğŸ“– ç›®å½•

- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [æ¶æ„è¯¦è§£](#æ¶æ„è¯¦è§£)
- [ç¯å¢ƒéš”ç¦»](#ç¯å¢ƒéš”ç¦»)
- [RDSè¿ç§»è®°å½•](#rdsè¿ç§»è®°å½•)
- [æˆæœ¬åˆ†æ](#æˆæœ¬åˆ†æ)
- [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [å‚è€ƒèµ„æ–™](#å‚è€ƒèµ„æ–™)

---

## å¿«é€Ÿå¼€å§‹

### ä¸€é”®éƒ¨ç½²

```bash
./deploy-lambda.sh
```

å°±è¿™ä¹ˆç®€å•ï¼è„šæœ¬ä¼šè‡ªåŠ¨ï¼š

1. æ„å»º NestJS é¡¹ç›®
2. ç”Ÿæˆ Prisma Client
3. æ„å»º SAM åº”ç”¨
4. éƒ¨ç½²åˆ° AWS Lambda

### å‰ææ¡ä»¶

#### 1. AWS å‡­è¯é…ç½®

```bash
aws configure
# è¾“å…¥ Access Key ID å’Œ Secret Access Key
```

éªŒè¯é…ç½®ï¼š

```bash
aws sts get-caller-identity
```

#### 2. ç¯å¢ƒå˜é‡é…ç½®

`.env` æ–‡ä»¶åº”åŒ…å«ï¼š

```bash
NODE_ENV=development
PORT=3000

# æœ¬åœ°å¼€å‘æ•°æ®åº“ï¼ˆæ—§RDSï¼Œæœ‰å…¬ç½‘è®¿é—®ï¼‰
DATABASE_URL="postgresql://postgres:<password>@<dev-endpoint>:5432/postgres?schema=public&sslmode=require"

# Lambdaç”Ÿäº§ç¯å¢ƒæ•°æ®åº“ï¼ˆæ–°RDSï¼ŒVPCç§æœ‰ï¼‰
DATABASE_URL_PROD="postgresql://postgres:<password>@<prod-endpoint>:5432/postgres?schema=public&sslmode=require"
```

### æµ‹è¯•éƒ¨ç½²

**ç”Ÿäº§ç¯å¢ƒï¼ˆLambdaï¼‰**:

```bash
# é¦–é¡µ
curl https://<your-api-id>.execute-api.us-east-1.amazonaws.com/

# ç”¨æˆ·åˆ—è¡¨
curl https://<your-api-id>.execute-api.us-east-1.amazonaws.com/users

# åˆ›å»ºç”¨æˆ·
curl -X POST https://<your-api-id>.execute-api.us-east-1.amazonaws.com/users \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","name":"Test"}'
```

**æœ¬åœ°å¼€å‘**:

```bash
# å¯åŠ¨æœ¬åœ°æœåŠ¡
pnpm run start:dev

# æµ‹è¯•API
curl http://localhost:3000/users
```

---

## æ¶æ„è¯¦è§£

### å½“å‰VPCæ‹“æ‰‘

```
Internet
    â†“
Internet Gateway
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VPC: <YOUR-VPC-ID> (10.0.0.0/16)                â”‚
â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  å…¬ç½‘å­ç½‘ (10.0.1.0/24)            â”‚          â”‚
â”‚  â”‚  us-east-1a                        â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚          â”‚
â”‚  â”‚  â”‚NAT Gateway â”‚â”€â”€â”‚ Elastic IP   â”‚â”€â”¼â”€â†’Internetâ”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â†“                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ç§ç½‘å­ç½‘ 1-3                      â”‚          â”‚
â”‚  â”‚  10.0.11-13.0/24                   â”‚          â”‚
â”‚  â”‚  us-east-1a/b/c                    â”‚          â”‚
â”‚  â”‚                                     â”‚          â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚          â”‚
â”‚  â”‚  â”‚ Lambda   â”‚â”€â”€â”‚ RDS (ç”Ÿäº§)   â”‚   â”‚          â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
    API Gateway
         â†‘
      Internet
```

### ç½‘ç»œé…ç½®

#### å­ç½‘è§„åˆ’

| å­ç½‘ç±»å‹ | CIDR         | å¯ç”¨åŒº     | è·¯ç”± | ç”¨é€”         |
| -------- | ------------ | ---------- | ---- | ------------ |
| å…¬ç½‘     | 10.0.1.0/24  | us-east-1a | IGW  | NAT Gateway  |
| ç§ç½‘1    | 10.0.11.0/24 | us-east-1a | NAT  | Lambda + RDS |
| ç§ç½‘2    | 10.0.12.0/24 | us-east-1b | NAT  | Lambda + RDS |
| ç§ç½‘3    | 10.0.13.0/24 | us-east-1c | NAT  | Lambda + RDS |

#### è·¯ç”±è¡¨

**å…¬ç½‘å­ç½‘**:

- `0.0.0.0/0` â†’ Internet Gateway

**ç§ç½‘å­ç½‘**:

- `0.0.0.0/0` â†’ NAT Gateway

### Lambdaé…ç½®

| å±æ€§   | å€¼                         |
| ------ | -------------------------- |
| å‡½æ•°å | nest-demo-stack-nestjs-api |
| è¿è¡Œæ—¶ | Node.js 24.x               |
| æ¶æ„   | x86_64                     |
| å†…å­˜   | 1024 MB                    |
| è¶…æ—¶   | 30ç§’                       |
| VPC    | å¯ç”¨ï¼ˆ3ä¸ªç§æœ‰å­ç½‘ï¼‰        |

### RDSæ•°æ®åº“

#### ç”Ÿäº§æ•°æ®åº“ï¼ˆVPCç§æœ‰ - Aurora Serverless v2ï¼‰

| å±æ€§     | å€¼                        |
| -------- | ------------------------- |
| å®ä¾‹ID   | database-nest-demo-aurora |
| å¼•æ“     | Aurora PostgreSQL 17.2    |
| å®ä¾‹ç±»å‹ | Aurora Serverless v2      |
| å…¬ç½‘è®¿é—® | âŒ ç¦ç”¨ï¼ˆVPCç§æœ‰ï¼‰        |
| ç”¨é€”     | Lambdaç”Ÿäº§ç¯å¢ƒ            |

#### å¼€å‘æ•°æ®åº“ï¼ˆå…¬ç½‘è®¿é—®ï¼‰

| å±æ€§     | å€¼                 |
| -------- | ------------------ |
| å®ä¾‹ID   | database-nest-demo |
| å¼•æ“     | PostgreSQL 17.6    |
| å®ä¾‹ç±»å‹ | db.t4g.micro       |
| å…¬ç½‘è®¿é—® | âœ… å¯ç”¨            |
| ç”¨é€”     | æœ¬åœ°å¼€å‘æµ‹è¯•       |

### å®‰å…¨ç»„è§„åˆ™

#### Lambdaå®‰å…¨ç»„

**å‡ºç«™è§„åˆ™**:

- PostgreSQL (5432) â†’ 0.0.0.0/0
- HTTPS (443) â†’ 0.0.0.0/0

#### RDSç”Ÿäº§å®‰å…¨ç»„

**å…¥ç«™è§„åˆ™**:

- PostgreSQL (5432) â† Lambdaå®‰å…¨ç»„ï¼ˆä»…å…è®¸Lambdaè®¿é—®ï¼‰

---

## ç¯å¢ƒéš”ç¦»

### åŒæ•°æ®åº“æ¶æ„

| ç¯å¢ƒ | è¿è¡Œä½ç½® | æ•°æ®åº“                    | å…¬ç½‘è®¿é—® | ç”¨é€”     |
| ---- | -------- | ------------------------- | -------- | -------- |
| å¼€å‘ | æœ¬åœ°     | database-nest-demo        | âœ…       | å¼€å‘æµ‹è¯• |
| ç”Ÿäº§ | Lambda   | database-nest-demo-aurora | âŒ       | ç”Ÿäº§ç¯å¢ƒ |

### ç¯å¢ƒåˆ‡æ¢

**æœ¬åœ°å¼€å‘**:

```bash
pnpm run start:dev
# è‡ªåŠ¨ä½¿ç”¨ DATABASE_URLï¼ˆå¼€å‘æ•°æ®åº“ï¼‰
```

**Lambdaéƒ¨ç½²**:

```bash
./deploy-lambda.sh
# è‡ªåŠ¨ä½¿ç”¨ DATABASE_URL_PRODï¼ˆç”Ÿäº§æ•°æ®åº“ï¼‰
```

### éƒ¨ç½²è„šæœ¬è¯¦è§£

`deploy-lambda.sh` æ‰§è¡Œæµç¨‹ï¼š

```bash
1. è¯»å– .env é…ç½®
2. åˆ‡æ¢åˆ°ç”Ÿäº§æ•°æ®åº“ (DATABASE_URL_PROD)
3. æ„å»º NestJS é¡¹ç›® (pnpm build)
4. ç”Ÿæˆ Prisma Client (pnpm prisma generate)
5. åº”ç”¨æ•°æ®åº“è¿ç§»åˆ°ç”Ÿäº§ç¯å¢ƒ (pnpm prisma migrate deploy)
6. æ„å»º SAM åº”ç”¨ (sam build)
7. å¤åˆ¶ dist ç›®å½•å’Œ Prisma å®¢æˆ·ç«¯
8. éƒ¨ç½²åˆ° AWSï¼Œä¼ é€’ç¯å¢ƒå˜é‡å‚æ•°
```

#### ç¯å¢ƒå˜é‡æ³¨å…¥æœºåˆ¶

**å…³é”®ä»£ç **ï¼ˆdeploy-lambda.sh ç¬¬10è¡Œå’Œç¬¬43è¡Œï¼‰ï¼š

```bash
# 1. è¯»å– .env æ–‡ä»¶
source .env

# 2. é‡å†™ DATABASE_URL ä¸ºç”Ÿäº§æ•°æ®åº“
DATABASE_URL="${DATABASE_URL_PROD}"

# 3. é€šè¿‡ CloudFormation å‚æ•°ä¼ é€’ç»™ Lambda
sam deploy \
  --parameter-overrides "Environment=production DatabaseUrl=\"${DATABASE_URL}\""
```

**éƒ¨ç½²æ—¶çš„æ•°æ®æµ**ï¼š

```
.env æ–‡ä»¶
â”œâ”€â”€ DATABASE_URL (å¼€å‘) - ç”¨äºæœ¬åœ°å¼€å‘
â””â”€â”€ DATABASE_URL_PROD (ç”Ÿäº§) - ç”¨äº Lambda
         â†“
   deploy-lambda.sh é‡å†™
   DATABASE_URL="${DATABASE_URL_PROD}"
         â†“
   sam deploy å‚æ•°ä¼ é€’
   --parameter-overrides "DatabaseUrl=..."
         â†“
   template.yaml å‚æ•°å®šä¹‰
   Parameters.DatabaseUrl
         â†“
   Lambda ç¯å¢ƒå˜é‡æ³¨å…¥
   Environment.Variables.DATABASE_URL: !Ref DatabaseUrl
         â†“
   è¿è¡Œæ—¶è¯»å–
   process.env.DATABASE_URL
```

**å¼€å‘ç¯å¢ƒ vs ç”Ÿäº§ç¯å¢ƒ**ï¼š

| ç¯å¢ƒ     | ç¯å¢ƒå˜é‡æ¥æº        | æ³¨å…¥æ–¹å¼                     | æ—¶æœº       |
| -------- | ------------------- | ---------------------------- | ---------- |
| **å¼€å‘** | `.env` æ–‡ä»¶         | NestJS ConfigModule (dotenv) | åº”ç”¨å¯åŠ¨æ—¶ |
| **ç”Ÿäº§** | CloudFormation å‚æ•° | AWS Lambda è¿è¡Œæ—¶            | è¿›ç¨‹å¯åŠ¨å‰ |

ä¸¤ä¸ªç¯å¢ƒçš„ä»£ç å®Œå…¨ç›¸åŒï¼ˆ`process.env.DATABASE_URL`ï¼‰ï¼Œä½†æ•°æ®æ¥æºä¸åŒï¼

---

## RDSè¿ç§»è®°å½•

### è¿ç§»èƒŒæ™¯

åŸæ¶æ„ä¸­ Lambda å’Œ RDS åœ¨ä¸åŒ VPCï¼Œé€šè¿‡å…¬ç½‘è¿æ¥ã€‚è¿ç§»åçš„ä¼˜åŠ¿ï¼š

- âœ… **æ›´å¿«**: å†…ç½‘é€šä¿¡ï¼Œå»¶è¿Ÿé™ä½
- âœ… **æ›´å®‰å…¨**: RDS æ— å…¬ç½‘æš´éœ²
- âœ… **æ›´ä¾¿å®œ**: VPCå†…ç½‘æµé‡å…è´¹

### è¿ç§»æ­¥éª¤ï¼ˆå·²å®Œæˆï¼‰

1. âœ… åˆ›å»º RDS å¿«ç…§
2. âœ… åˆ›å»º DB å­ç½‘ç»„ï¼ˆ3ä¸ªç§æœ‰å­ç½‘ï¼‰
3. âœ… åˆ›å»º RDS å®‰å…¨ç»„ï¼ˆå…è®¸Lambdaè®¿é—®ï¼‰
4. âœ… ä»å¿«ç…§æ¢å¤åˆ°æ–° VPC
5. âœ… æ›´æ–°ç¯å¢ƒå˜é‡ï¼ˆDATABASE_URL_PRODï¼‰
6. âœ… é‡æ–°éƒ¨ç½² Lambda
7. âœ… éªŒè¯åŠŸèƒ½æ­£å¸¸

### è¿ç§»è„šæœ¬

ä¿ç•™çš„è¿ç§»è„šæœ¬: `migrate-rds-to-lambda-vpc.sh`ï¼ˆå·²æ‰§è¡Œå®Œæˆï¼Œå¯ä½œå‚è€ƒï¼‰

---

## æˆæœ¬åˆ†æ

### æœˆåº¦æˆæœ¬ä¼°ç®—

| èµ„æº         | æ•°é‡          | å•ä»·        | æœˆæˆæœ¬      |
| ------------ | ------------- | ----------- | ----------- |
| NAT Gateway  | 1             | $0.045/å°æ—¶ | $32.40      |
| NAT æ•°æ®ä¼ è¾“ | ~10GB         | $0.045/GB   | $0.45       |
| Lambda è¯·æ±‚  | <100ä¸‡        | å…è´¹        | $0.00       |
| Lambda è®¡ç®—  | <40ä¸‡GB-s     | å…è´¹        | $0.00       |
| API Gateway  | <100ä¸‡        | å…è´¹        | $0.00       |
| RDS ç”Ÿäº§     | 1 Ã— t4g.micro | ~$12.5/æœˆ   | $12.50      |
| RDS å¼€å‘     | 1 Ã— t4g.micro | ~$12.5/æœˆ   | $12.50      |
| **æ€»è®¡**     |               |             | **~$57.85** |

### æˆæœ¬ä¼˜åŒ–å»ºè®®

1. **åˆ é™¤å¼€å‘RDS**: å¦‚æœä¸éœ€è¦å…¬ç½‘æ•°æ®åº“ï¼Œå¯èŠ‚çœ $12.5/æœˆ
2. **VPCç«¯ç‚¹æ›¿ä»£NAT**: å¦‚æœLambdaåªè®¿é—®AWSæœåŠ¡ï¼Œå¯èŠ‚çœ $32.4/æœˆ
3. **æŒ‰éœ€å¯åŠ¨å¼€å‘RDS**: åªåœ¨éœ€è¦æ—¶å¯åŠ¨

---

## ç›‘æ§å’Œæ—¥å¿—

### CloudWatch æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹
aws logs tail /aws/lambda/nest-demo-stack-nestjs-api --follow

# æŸ¥çœ‹æœ€è¿‘5åˆ†é’Ÿ
aws logs tail /aws/lambda/nest-demo-stack-nestjs-api --since 5m

# æŸ¥çœ‹ç‰¹å®šæ—¶é—´èŒƒå›´
aws logs tail /aws/lambda/nest-demo-stack-nestjs-api \
  --start-time '2024-01-01T00:00:00' \
  --end-time '2024-01-01T23:59:59'
```

### å…³é”®æŒ‡æ ‡

åœ¨ AWS Console â†’ Lambda â†’ ç›‘æ§é¢æ¿ï¼š

- **Invocations**: è°ƒç”¨æ¬¡æ•°
- **Duration**: å¹³å‡å“åº”æ—¶é—´
- **Error rate**: é”™è¯¯ç‡
- **Throttles**: é™æµæ¬¡æ•°
- **Concurrent executions**: å¹¶å‘æ‰§è¡Œæ•°

---

## æ•…éšœæ’æŸ¥

### Lambda æ— æ³•è¿æ¥ RDS

**ç—‡çŠ¶**: API è¿”å› 500 é”™è¯¯ï¼Œæ—¥å¿—æ˜¾ç¤ºæ•°æ®åº“è¿æ¥è¶…æ—¶

**æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥å®‰å…¨ç»„**:

```bash
# Lambdaå®‰å…¨ç»„å‡ºç«™è§„åˆ™
aws ec2 describe-security-groups --group-ids <lambda-sg-id>

# RDSå®‰å…¨ç»„å…¥ç«™è§„åˆ™
aws ec2 describe-security-groups --group-ids <rds-sg-id>
```

2. **éªŒè¯RDSç«¯ç‚¹**:

```bash
# Aurora é›†ç¾¤ä½¿ç”¨ä¸åŒçš„å‘½ä»¤
aws rds describe-db-clusters \
  --db-cluster-identifier database-nest-demo-aurora \
  --query 'DBClusters[0].Endpoint'
```

3. **æ£€æŸ¥Lambdaç¯å¢ƒå˜é‡**:

```bash
aws lambda get-function-configuration \
  --function-name nest-demo-stack-nestjs-api \
  --query 'Environment.Variables.DATABASE_URL'
```

### Lambda å†·å¯åŠ¨æ—¶é—´è¿‡é•¿

**ç—‡çŠ¶**: é¦–æ¬¡è°ƒç”¨å“åº”æ—¶é—´ >10ç§’

**ä¼˜åŒ–æ–¹æ¡ˆ**:

1. å¯ç”¨é¢„ç•™å¹¶å‘
2. ä¼˜åŒ–ä¾èµ–åŒ…å¤§å°
3. ä½¿ç”¨ Lambda å‡½æ•°ç¼“å­˜
4. è€ƒè™‘ Lambda SnapStart

### éƒ¨ç½²å¤±è´¥

**å¸¸è§é—®é¢˜**:

1. **æ‰¾ä¸åˆ°æ¨¡å—**: ç¡®ä¿ `dist` å’Œ `.prisma` è¢«å¤åˆ¶
2. **æƒé™ä¸è¶³**: æ£€æŸ¥ AWS å‡­è¯å’Œ IAM æƒé™
3. **VPCé…é¢ä¸è¶³**: æ£€æŸ¥ VPCã€å­ç½‘ã€å®‰å…¨ç»„é…é¢

### æœ¬åœ°å’Œç”Ÿäº§æ•°æ®ä¸åŒæ­¥

**è¿™æ˜¯é¢„æœŸè¡Œä¸ºï¼** ä¸¤ä¸ªç¯å¢ƒä½¿ç”¨ä¸åŒçš„æ•°æ®åº“ï¼Œæ•°æ®å®Œå…¨éš”ç¦»ã€‚

å¦‚éœ€åŒæ­¥æ•°æ®ï¼Œæ‰‹åŠ¨å¯¼å‡ºå¯¼å…¥ï¼š

```bash
# å¯¼å‡ºå¼€å‘æ•°æ®åº“
pg_dump -h <dev-endpoint> -U postgres -d postgres > backup.sql

# å¯¼å…¥åˆ°ç”Ÿäº§æ•°æ®åº“ï¼ˆéœ€è¦VPNæˆ–è·³æ¿æœºï¼‰
psql -h <prod-endpoint> -U postgres -d postgres < backup.sql
```

---

## å‚è€ƒèµ„æ–™

### ç›¸å…³æ–‡ä»¶

- `deploy-lambda.sh` - ä¸€é”®éƒ¨ç½²è„šæœ¬
- `template.yaml` - SAM æ¨¡æ¿é…ç½®
- `samconfig.toml` - SAM éƒ¨ç½²é…ç½®
- `src/lambda.ts` - Lambda å¤„ç†ç¨‹åº
- `.env` - ç¯å¢ƒå˜é‡é…ç½®
- `.samignore` - SAM æ‰“åŒ…å¿½ç•¥è§„åˆ™

### AWS èµ„æº

- [AWS SAM å®˜æ–¹æ–‡æ¡£](https://docs.aws.amazon.com/serverless-application-model/)
- [Lambda æœ€ä½³å®è·µ](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)
- [VPC é…ç½®æŒ‡å—](https://docs.aws.amazon.com/lambda/latest/dg/configuration-vpc.html)

### å½“å‰éƒ¨ç½²ä¿¡æ¯

- **VPC ID**: æŸ¥çœ‹ `template.yaml` æˆ– CloudFormation è¾“å‡º
- **API Gateway**: æŸ¥çœ‹ CloudFormation è¾“å‡º `ApiUrl`
- **Lambda å‡½æ•°å**: nest-demo-stack-nestjs-api
- **åŒºåŸŸ**: us-east-1

---

## æ¸…ç†èµ„æº

### åˆ é™¤ Lambda å’Œ VPC

```bash
sam delete --stack-name nest-demo-stack
```

> âš ï¸ è¿™ä¸ä¼šåˆ é™¤ RDS æ•°æ®åº“ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤

### åˆ é™¤ RDS æ•°æ®åº“

```bash
# ç”Ÿäº§æ•°æ®åº“ï¼ˆAurora é›†ç¾¤ï¼‰
aws rds delete-db-cluster \
  --db-cluster-identifier database-nest-demo-aurora \
  --skip-final-snapshot

# å¼€å‘æ•°æ®åº“
aws rds delete-db-instance \
  --db-instance-identifier database-nest-demo \
  --skip-final-snapshot
```

---

## æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰

- [ ] AWS å‡­è¯å·²é…ç½®
- [ ] `.env` æ–‡ä»¶åŒ…å«æ­£ç¡®çš„æ•°æ®åº“è¿æ¥
- [ ] æœ¬åœ°å¯ä»¥è¿æ¥å¼€å‘æ•°æ®åº“
- [ ] å·²æ‰§è¡Œ `pnpm install`

### éƒ¨ç½²å

- [ ] Lambda å‡½æ•°éƒ¨ç½²æˆåŠŸ
- [ ] API Gateway ç«¯ç‚¹å¯è®¿é—®
- [ ] Lambda å¯ä»¥è¿æ¥ç”Ÿäº§ RDS
- [ ] æœ¬åœ°å’Œç”Ÿäº§ç¯å¢ƒæ•°æ®éš”ç¦»
- [ ] CloudWatch æ—¥å¿—æ­£å¸¸è®°å½•

### å®‰å…¨æ£€æŸ¥

- [ ] RDS ç”Ÿäº§æ•°æ®åº“æ— å…¬ç½‘è®¿é—®
- [ ] å®‰å…¨ç»„è§„åˆ™æœ€å°æƒé™
- [ ] æ•°æ®åº“å¯†ç å¼ºåº¦è¶³å¤Ÿ
- [ ] API Gateway è€ƒè™‘æ·»åŠ è®¤è¯ï¼ˆå¯é€‰ï¼‰
- [ ] è€ƒè™‘å¯ç”¨ WAFï¼ˆå¯é€‰ï¼‰

---

## æ›´æ–°æ—¥å¿—

### 2024-12-16

- âœ… å®Œæˆ RDS è¿ç§»åˆ° Lambda VPC
- âœ… å®ç°å¼€å‘/ç”Ÿäº§æ•°æ®åº“éš”ç¦»
- âœ… ç®€åŒ–éƒ¨ç½²æµç¨‹ä¸ºä¸€é”®éƒ¨ç½²
- âœ… æ›´æ–°æ‰€æœ‰æ–‡æ¡£
